{% extends "base.html" %}

{% block title %}{{ character.name }} - Progression History - WoW Guild Analytics{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <a href="{{ url_for('main.guild_detail', guild_id=character.guild_id) }}" class="btn btn-outline-secondary mb-2">
                    <i class="bi bi-arrow-left me-2"></i>Back to Guild
                </a>
                <h1><i class="bi bi-graph-up me-2"></i>{{ character.name }} - Progression History</h1>
                <p class="text-muted">{{ character.realm }} - {{ character.character_class or 'Unknown Class' }}</p>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Current Level</h5>
                        <p class="card-text display-4">{{ character.level or '-' }}</p>
                        {% if level_gain != 0 %}
                        <small class="text-{{ 'success' if level_gain > 0 else 'danger' }}">
                            <i class="bi bi-{{ 'arrow-up' if level_gain > 0 else 'arrow-down' }}"></i>
                            {{ level_gain if level_gain > 0 else level_gain * -1 }} since tracking began
                        </small>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Avg Item Level</h5>
                        <p class="card-text display-4">{{ character.average_item_level or '-' }}</p>
                        {% if ilvl_gain != 0 %}
                        <small class="text-{{ 'success' if ilvl_gain > 0 else 'danger' }}">
                            <i class="bi bi-{{ 'arrow-up' if ilvl_gain > 0 else 'arrow-down' }}"></i>
                            {{ ilvl_gain if ilvl_gain > 0 else ilvl_gain * -1 }} since tracking began
                        </small>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Equipped iLvl</h5>
                        <p class="card-text display-4">{{ character.equipped_item_level or '-' }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Snapshots</h5>
                        <p class="card-text display-4">{{ pagination.total }}</p>
                        <small class="text-muted">progression records</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Progression Chart -->
        {% if progression_entries %}
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-graph-up-arrow me-2"></i>Progression Chart</h5>
            </div>
            <div class="card-body">
                <canvas id="progressionChart" style="max-height: 400px;"></canvas>
            </div>
        </div>
        {% endif %}
        
        <!-- Progression History Table -->
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-table me-2"></i>Progression History</h5>
            </div>
            <div class="card-body">
                {% if progression_entries %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Level</th>
                                <th>Level Change</th>
                                <th>Avg Item Level</th>
                                <th>iLvl Change</th>
                                <th>Equipped iLvl</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in progression_entries %}
                            {% set prev_entry = progression_entries[loop.index] if loop.index < progression_entries|length else None %}
                            <tr>
                                <td>
                                    <span title="{{ entry.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}">
                                        {{ entry.timestamp.strftime('%Y-%m-%d %H:%M') }}
                                    </span>
                                </td>
                                <td>
                                    <strong>{{ entry.character_level or '-' }}</strong>
                                </td>
                                <td>
                                    {% if prev_entry and prev_entry.character_level and entry.character_level %}
                                        {% set level_change = entry.character_level - prev_entry.character_level %}
                                        {% if level_change != 0 %}
                                        <span class="badge bg-{{ 'success' if level_change > 0 else 'danger' }}">
                                            <i class="bi bi-{{ 'arrow-up' if level_change > 0 else 'arrow-down' }}"></i>
                                            {{ level_change if level_change > 0 else level_change * -1 }}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ entry.average_item_level or '-' }}</td>
                                <td>
                                    {% if prev_entry and prev_entry.average_item_level and entry.average_item_level %}
                                        {% set ilvl_change = entry.average_item_level - prev_entry.average_item_level %}
                                        {% if ilvl_change != 0 %}
                                        <span class="badge bg-{{ 'success' if ilvl_change > 0 else 'danger' }}">
                                            <i class="bi bi-{{ 'arrow-up' if ilvl_change > 0 else 'arrow-down' }}"></i>
                                            {{ ilvl_change if ilvl_change > 0 else ilvl_change * -1 }}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ entry.equipped_item_level or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if pagination.pages > 1 %}
                <nav aria-label="Progression pagination">
                    <ul class="pagination justify-content-center mt-4">
                        <!-- Previous -->
                        <li class="page-item {{ 'disabled' if not pagination.has_prev else '' }}">
                            <a class="page-link" href="{{ url_for('main.character_progression', character_id=character.id, page=pagination.prev_num) if pagination.has_prev else '#' }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        
                        <!-- Page Numbers -->
                        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                            {% if page_num %}
                                <li class="page-item {{ 'active' if page_num == pagination.page else '' }}">
                                    <a class="page-link" href="{{ url_for('main.character_progression', character_id=character.id, page=page_num) }}">
                                        {{ page_num }}
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        <!-- Next -->
                        <li class="page-item {{ 'disabled' if not pagination.has_next else '' }}">
                            <a class="page-link" href="{{ url_for('main.character_progression', character_id=character.id, page=pagination.next_num) if pagination.has_next else '#' }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
                
                <div class="text-center text-muted mt-2">
                    <small>
                        Showing {{ (pagination.page - 1) * pagination.per_page + 1 }} 
                        to {{ min(pagination.page * pagination.per_page, pagination.total) }} 
                        of {{ pagination.total }} entries
                    </small>
                </div>
                {% endif %}
                
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <p class="text-muted mt-3">No progression history yet. This character's progress will be tracked during future guild syncs.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if progression_entries %}
<script>
    // Prepare data for chart (reverse order to show oldest to newest)
    const progressionData = {{ progression_data_for_chart | tojson }}.reverse();
    
    const labels = progressionData.map(entry => {
        const date = new Date(entry.timestamp);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    });
    
    const levelData = progressionData.map(entry => entry.character_level);
    const avgIlvlData = progressionData.map(entry => entry.average_item_level);
    const equippedIlvlData = progressionData.map(entry => entry.equipped_item_level);
    
    // Create chart
    const ctx = document.getElementById('progressionChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Level',
                    data: levelData,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    yAxisID: 'y',
                    tension: 0.1
                },
                {
                    label: 'Avg Item Level',
                    data: avgIlvlData,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.1
                },
                {
                    label: 'Equipped iLvl',
                    data: equippedIlvlData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Level'
                    },
                    min: 0,
                    max: 60
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Item Level'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        }
                    }
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}
