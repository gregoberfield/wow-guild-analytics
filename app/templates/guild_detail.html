{% extends "base.html" %}

{% block title %}{{ guild.name }} - WoW Guild Analytics{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>{{ guild.name }} - {{ guild.realm }}</h1>
            <div>
                <small class="text-muted me-3">Last Updated: {{ guild.last_updated.strftime('%Y-%m-%d %H:%M') if guild.last_updated else 'Never' }}</small>
                <a href="{{ url_for('main.guild_history', guild_id=guild.id) }}" class="btn btn-outline-info me-2">
                    <i class="bi bi-clock-history"></i> View History
                </a>
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('main.raid_composer', guild_id=guild.id) }}" class="btn btn-outline-success me-2">
                    <i class="bi bi-robot"></i> AI Raid Composer
                </a>
                <form method="POST" action="{{ url_for('main.sync_character_details', guild_id=guild.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-primary" onclick="return confirm('This will fetch detailed character information for all {{ total_members }} members. This may take several minutes. Continue?');">
                        <i class="bi bi-arrow-repeat"></i> Sync Character Details
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Members</h5>
                        <p class="card-text display-4">{{ total_members }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Level 60s</h5>
                        <p class="card-text display-4">{{ level_60_count }}</p>
                        <small class="text-muted">{{ "%.1f"|format((level_60_count / total_members * 100) if total_members > 0 else 0) }}%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Avg Item Level</h5>
                        <p class="card-text display-4">{{ average_item_level }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Faction</h5>
                        <p class="card-text display-6">{{ guild.faction or 'Unknown' }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        {% if data_completeness < 100 %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="bi bi-info-circle"></i> <strong>Character Data Status:</strong> 
            {{ chars_with_profiles }} of {{ total_members }} characters ({{ data_completeness }}%) have detailed profile information.
            {% if data_completeness < 50 %}
            Click "Sync Character Details" above to fetch missing data like item levels, gender, and specializations.
            {% endif %}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Level Distribution by Class (Levels 1-59)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="levelClassChart" style="max-height: 500px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Level 60 Breakdown by Class</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="level60ClassChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Level 60 Statistics</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Class</th>
                                    <th class="text-end">Count</th>
                                    <th class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for class_name in level_60_by_class.keys()|sort %}
                                <tr>
                                    <td>{{ class_name }}</td>
                                    <td class="text-end">{{ level_60_by_class[class_name] }}</td>
                                    <td class="text-end">{{ level_60_percentages[class_name] }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="fw-bold">
                                    <td>Total</td>
                                    <td class="text-end">{{ level_60_count }}</td>
                                    <td class="text-end">100.0%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Level 60 Specialization Breakdown by Class</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="classSpecChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Class Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="classChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Race Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="raceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Guild Roster ({{ total_characters }} members)</h5>
                        <div class="d-flex gap-2 align-items-center">
                            <!-- Search Filter -->
                            <form method="GET" class="d-flex gap-2" id="roster-controls">
                                <input type="hidden" name="sort_by" value="{{ sort_by }}">
                                <input type="hidden" name="sort_order" value="{{ sort_order }}">
                                <input type="hidden" name="per_page" value="{{ per_page }}">
                                
                                <div class="input-group" style="width: 250px;">
                                    <input type="text" 
                                           class="form-control form-control-sm" 
                                           name="search" 
                                           value="{{ search }}"
                                           placeholder="Search by name..."
                                           id="search-input">
                                    {% if search %}
                                    <a href="{{ url_for('main.guild_detail', guild_id=guild.id, sort_by=sort_by, sort_order=sort_order, per_page=per_page) }}" 
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-x"></i>
                                    </a>
                                    {% endif %}
                                </div>
                                
                                <!-- Per Page Selector -->
                                <select class="form-select form-select-sm" 
                                        name="per_page" 
                                        id="per-page-select"
                                        onchange="this.form.submit()"
                                        style="width: 120px;">
                                    <option value="20" {% if per_page == 20 %}selected{% endif %}>20 per page</option>
                                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50 per page</option>
                                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100 per page</option>
                                    <option value="0" {% if per_page == 0 %}selected{% endif %}>Show All</option>
                                </select>
                            </form>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">Avatar</th>
                                        <th>
                                            <a href="{{ url_for('main.guild_detail', guild_id=guild.id, sort_by='name', sort_order='asc' if sort_by == 'name' and sort_order == 'desc' else 'desc', per_page=per_page, search=search) }}" 
                                               class="text-decoration-none text-dark">
                                                Name
                                                {% if sort_by == 'name' %}
                                                    <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                                {% else %}
                                                    <i class="bi bi-arrow-down-up text-muted"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th>
                                            <a href="{{ url_for('main.guild_detail', guild_id=guild.id, sort_by='level', sort_order='asc' if sort_by == 'level' and sort_order == 'desc' else 'desc', per_page=per_page, search=search) }}" 
                                               class="text-decoration-none text-dark">
                                                Level
                                                {% if sort_by == 'level' %}
                                                    <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                                {% else %}
                                                    <i class="bi bi-arrow-down-up text-muted"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                                                                <th>
                                            <a href="{{ url_for('main.guild_detail', guild_id=guild.id, sort_by='class', sort_order='asc' if sort_by == 'class' and sort_order == 'desc' else 'desc', per_page=per_page, search=search) }}" 
                                               class="text-decoration-none text-dark">
                                                Class
                                                {% if sort_by == 'class' %}
                                                    <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                                {% else %}
                                                    <i class="bi bi-arrow-down-up text-muted"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th>
                                            <a href="{{ url_for('main.guild_detail', guild_id=guild.id, sort_by='race', sort_order='asc' if sort_by == 'race' and sort_order == 'desc' else 'desc', per_page=per_page, search=search) }}" 
                                               class="text-decoration-none text-dark">
                                                Race
                                                {% if sort_by == 'race' %}
                                                    <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                                {% else %}
                                                    <i class="bi bi-arrow-down-up text-muted"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th>
                                            <a href="{{ url_for('main.guild_detail', guild_id=guild.id, sort_by='spec', sort_order='asc' if sort_by == 'spec' and sort_order == 'desc' else 'desc', per_page=per_page, search=search) }}" 
                                               class="text-decoration-none text-dark">
                                                Spec
                                                {% if sort_by == 'spec' %}
                                                    <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                                {% else %}
                                                    <i class="bi bi-arrow-down-up text-muted"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th>
                                            <a href="{{ url_for('main.guild_detail', guild_id=guild.id, sort_by='ilvl', sort_order='asc' if sort_by == 'ilvl' and sort_order == 'desc' else 'desc', per_page=per_page, search=search) }}" 
                                               class="text-decoration-none text-dark">
                                                Item Level
                                                {% if sort_by == 'ilvl' %}
                                                    <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                                {% else %}
                                                    <i class="bi bi-arrow-down-up text-muted"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th>
                                            <a href="{{ url_for('main.guild_detail', guild_id=guild.id, sort_by='rank', sort_order='asc' if sort_by == 'rank' and sort_order == 'desc' else 'desc', per_page=per_page, search=search) }}" 
                                               class="text-decoration-none text-dark">
                                                Rank
                                                {% if sort_by == 'rank' %}
                                                    <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                                {% else %}
                                                    <i class="bi bi-arrow-down-up text-muted"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th>
                                            <a href="{{ url_for('main.guild_detail', guild_id=guild.id, sort_by='last_seen', sort_order='asc' if sort_by == 'last_seen' and sort_order == 'desc' else 'desc', per_page=per_page, search=search) }}" 
                                               class="text-decoration-none text-dark">
                                                Last Seen
                                                {% if sort_by == 'last_seen' %}
                                                    <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                                {% else %}
                                                    <i class="bi bi-arrow-down-up text-muted"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for char in characters %}
                                    <tr>
                                        <td>
                                            {% if char.avatar_url %}
                                                <img src="{{ char.avatar_url }}" 
                                                     alt="{{ char.name }}" 
                                                     class="rounded-circle"
                                                     style="width: 40px; height: 40px;"
                                                     onerror="this.style.display='none'">
                                            {% else %}
                                                <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center" 
                                                     style="width: 40px; height: 40px; color: white; font-size: 18px;">
                                                    {{ char.name[0] if char.name else '?' }}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ char.name }}
                                            <a href="{{ url_for('main.character_progression', character_id=char.id) }}" 
                                               class="ms-2" 
                                               title="View progression history">
                                                <i class="bi bi-graph-up"></i>
                                            </a>
                                        </td>
                                        <td>{{ char.level or '-' }}</td>
                                        <td>{{ char.character_class or '-' }}</td>
                                        <td>{{ char.race or '-' }}</td>
                                        <td>{{ char.spec_name or '-' }}</td>
                                        <td>{{ char.average_item_level or '-' }}</td>
                                        <td>{{ char.rank if char.rank is not none else '-' }}</td>
                                        <td>
                                            {% if char.last_login_timestamp %}
                                                <span class="last-seen-date" data-timestamp="{{ char.last_login_timestamp }}">
                                                    {{ (char.last_login_timestamp / 1000) | int | timestamp_to_datetime | format_relative_time }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">Unknown</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination Controls -->
                        {% if pagination and per_page > 0 %}
                        <nav aria-label="Page navigation" class="mt-3">
                            <ul class="pagination justify-content-center">
                                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('main.guild_detail', guild_id=guild.id, page=pagination.prev_num, per_page=per_page, sort_by=sort_by, sort_order=sort_order, search=search) if pagination.has_prev else '#' }}">
                                        Previous
                                    </a>
                                </li>
                                
                                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                    {% if page_num %}
                                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                            <a class="page-link" href="{{ url_for('main.guild_detail', guild_id=guild.id, page=page_num, per_page=per_page, sort_by=sort_by, sort_order=sort_order, search=search) }}">
                                                {{ page_num }}
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('main.guild_detail', guild_id=guild.id, page=pagination.next_num, per_page=per_page, sort_by=sort_by, sort_order=sort_order, search=search) if pagination.has_next else '#' }}">
                                        Next
                                    </a>
                                </li>
                            </ul>
                            <div class="text-center text-muted small">
                                Showing {{ ((pagination.page - 1) * per_page) + 1 }} - {{ min(pagination.page * per_page, total_characters) }} of {{ total_characters }} members
                            </div>
                        </nav>
                        {% elif per_page == 0 %}
                        <div class="text-center text-muted small mt-3">
                            Showing all {{ total_characters }} members
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    // Configure Chart.js defaults for dark theme
    Chart.defaults.color = '#e0e0e0';  // Default text color
    Chart.defaults.borderColor = '#444';  // Default border color
    Chart.defaults.backgroundColor = '#1a1a1a';  // Default background
    
    // Configure default scales for dark theme
    Chart.defaults.scale.grid.color = '#333';
    Chart.defaults.scale.ticks.color = '#e0e0e0';
    Chart.defaults.scale.title.color = '#ffffff';
    
    // Configure default plugins for dark theme
    Chart.defaults.plugins.legend.labels.color = '#e0e0e0';
    Chart.defaults.plugins.title.color = '#ffffff';
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(0, 0, 0, 0.8)';
    Chart.defaults.plugins.tooltip.titleColor = '#ffffff';
    Chart.defaults.plugins.tooltip.bodyColor = '#e0e0e0';
    Chart.defaults.plugins.tooltip.borderColor = '#0d6efd';
    Chart.defaults.plugins.tooltip.borderWidth = 1;
    
    // Data from server
    const classDistributionData = {{ class_distribution | tojson | safe }};
    const raceDistributionData = {{ race_distribution | tojson | safe }};
    const levelClassData = {{ level_class_distribution | tojson | safe }};
    const allClasses = {{ all_classes | tojson | safe }};
    const level60ByClass = {{ level_60_by_class | tojson | safe }};
    const level60Percentages = {{ level_60_percentages | tojson | safe }};
    const level60ClassSpec = {{ level_60_class_spec | tojson | safe }};
    
    // WoW Class colors
    const classColors = {
        'Warrior': '#C41F3B',
        'Paladin': '#F58CBA',
        'Hunter': '#ABD473',
        'Rogue': '#FFF569',
        'Priest': '#FFFFFF',
        'Shaman': '#0070DE',
        'Mage': '#69CCF0',
        'Warlock': '#9482C9',
        'Druid': '#FF7D0A',
        'Death Knight': '#C41F3B',
        'Monk': '#00FF96',
        'Demon Hunter': '#A330C9',
        'Unknown': '#808080'
    };
    
    // Class Distribution Chart (Doughnut)
    const classCtx = document.getElementById('classChart').getContext('2d');
    const classLabels = Object.keys(classDistributionData);
    const classValues = Object.values(classDistributionData);
    const classChartColors = classLabels.map(cls => classColors[cls] || '#808080');
    
    new Chart(classCtx, {
        type: 'doughnut',
        data: {
            labels: classLabels,
            datasets: [{
                data: classValues,
                backgroundColor: classChartColors
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Race Distribution Chart (Bar)
    const raceCtx = document.getElementById('raceChart').getContext('2d');
    const raceLabels = Object.keys(raceDistributionData);
    const raceValues = Object.values(raceDistributionData);
    
    new Chart(raceCtx, {
        type: 'bar',
        data: {
            labels: raceLabels,
            datasets: [{
                label: 'Number of Characters',
                data: raceValues,
                backgroundColor: '#69b4ff'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Level Distribution by Class (Stacked Bar)
    const levelClassCtx = document.getElementById('levelClassChart').getContext('2d');
    
    // Get all unique levels and sort them
    const levels = Object.keys(levelClassData).map(Number).sort((a, b) => a - b);
    
    // Create datasets for each class
    const levelClassDatasets = allClasses.map(className => {
        return {
            label: className,
            data: levels.map(level => {
                return levelClassData[level] ? (levelClassData[level][className] || 0) : 0;
            }),
            backgroundColor: classColors[className] || '#808080'
        };
    });
    
    new Chart(levelClassCtx, {
        type: 'bar',
        data: {
            labels: levels,
            datasets: levelClassDatasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Character Level'
                    }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Characters'
                    },
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Level 60 Breakdown by Class (Horizontal Bar with percentages)
    const level60ClassCtx = document.getElementById('level60ClassChart').getContext('2d');
    const level60Classes = Object.keys(level60ByClass).sort((a, b) => level60ByClass[b] - level60ByClass[a]);
    const level60Values = level60Classes.map(cls => level60ByClass[cls]);
    const level60Colors = level60Classes.map(cls => classColors[cls] || '#808080');
    
    new Chart(level60ClassCtx, {
        type: 'bar',
        data: {
            labels: level60Classes,
            datasets: [{
                label: 'Level 60 Characters',
                data: level60Values,
                backgroundColor: level60Colors
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.x || 0;
                            const className = context.label || '';
                            const percentage = level60Percentages[className] || 0;
                            return `${value} characters (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Characters'
                    },
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Level 60 Class-Spec Breakdown Chart (Grouped Bar)
    const classSpecCtx = document.getElementById('classSpecChart').getContext('2d');
    
    // Get all classes that have level 60 characters
    const classesWithLevel60 = Object.keys(level60ClassSpec).sort();
    
    // Get all unique specs across all classes
    const allSpecs = new Set();
    classesWithLevel60.forEach(className => {
        Object.keys(level60ClassSpec[className]).forEach(spec => allSpecs.add(spec));
    });
    const specList = Array.from(allSpecs).sort();
    
    // Color palette for specs (different shades)
    const specColors = {
        // Use lighter/darker shades for variation
        'Affliction': '#9482C9',
        'Demonology': '#7A5FA6',
        'Destruction': '#5D4580',
        'Arms': '#C41F3B',
        'Fury': '#A01830',
        'Protection': '#7D1225',
        'Holy': '#F58CBA',
        'Retribution': '#D46B93',
        'Discipline': '#FFFFFF',
        'Shadow': '#D1D1D1',
        'Beast Mastery': '#ABD473',
        'Marksmanship': '#8FB25C',
        'Survival': '#739046',
        'Assassination': '#FFF569',
        'Combat': '#D4CC55',
        'Subtlety': '#B0A646',
        'Elemental': '#0070DE',
        'Enhancement': '#0058B2',
        'Restoration': '#004085',
        'Arcane': '#69CCF0',
        'Fire': '#56A9C7',
        'Frost': '#43869E',
        'Balance': '#FF7D0A',
        'Feral': '#D26708',
        'Guardian': '#A55206',
        'Unknown': '#808080'
    };
    
    // Create datasets for each spec
    const classSpecDatasets = specList.map(spec => {
        return {
            label: spec,
            data: classesWithLevel60.map(className => {
                return level60ClassSpec[className][spec] || 0;
            }),
            backgroundColor: specColors[spec] || '#808080'
        };
    });
    
    // Plugin to draw spec labels below class names
    const specLabelPlugin = {
        id: 'specLabels',
        afterDraw: (chart) => {
            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const yAxis = chart.scales.y;
            
            ctx.save();
            ctx.font = '11px sans-serif';
            
            classesWithLevel60.forEach((className, index) => {
                const specs = level60ClassSpec[className];
                const specEntries = Object.entries(specs).filter(([_, count]) => count > 0);
                
                if (specEntries.length === 0) return;
                
                // Get the x position for this class
                const x = xAxis.getPixelForValue(index);
                const startY = yAxis.bottom + 35; // Position below class name
                
                specEntries.forEach(([specName, count], specIndex) => {
                    const color = specColors[specName] || '#808080';
                    const y = startY + (specIndex * 15);
                    
                    // Draw colored square
                    ctx.fillStyle = color;
                    ctx.fillRect(x - 40, y - 8, 10, 10);
                    
                    // Draw spec name (light color for dark background)
                    ctx.fillStyle = '#e0e0e0';
                    ctx.textAlign = 'left';
                    ctx.fillText(`${specName} (${count})`, x - 27, y);
                });
            });
            
            ctx.restore();
        }
    };
    
    new Chart(classSpecCtx, {
        type: 'bar',
        data: {
            labels: classesWithLevel60,
            datasets: classSpecDatasets
        },
        options: {
            responsive: true,
            layout: {
                padding: {
                    bottom: 100  // Add space for spec labels
                }
            },
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        footer: function(tooltipItems) {
                            let sum = 0;
                            tooltipItems.forEach(function(tooltipItem) {
                                sum += tooltipItem.parsed.y;
                            });
                            return 'Total: ' + sum;
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Class'
                    }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Characters'
                    },
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        },
        plugins: [specLabelPlugin]
    });
</script>
{% endblock %}
